{% extends 'controlpanel/dashboard.html' %}
{% block title %}Artist Dashboard — {{ artist.name }}{% endblock %}
{% block content %}
<h1>Artist Dashboard — {{ artist.name }}</h1>
<div class="kpi">
  <div class="card"><h2>Total Sold</h2><div style="font-size:28px">{{ kpi.total }}</div></div>
  <div class="card"><h2>Card</h2><div style="font-size:28px">{{ kpi.card }}</div></div>
  <div class="card"><h2>Cash</h2><div style="font-size:28px">{{ kpi.cash }}</div></div>
  <div class="card"><h2>Comp</h2><div style="font-size:28px">{{ kpi.comp }}</div></div>
</div>
{% comment %} 
	Cash
  	/control/events/<event_id>/artist/<artist_id>/cash/ 

	Card
	/control/events/r/a/37d5bdc3-51a7-47f0-82a3-eeb649507b80/
{% endcomment %}

<div class="card">
  <h3>Top Events</h3>
  <table class="table">
    <thead><tr><th>Event</th><th>Date</th><th>Sold</th><th>Card</th><th>Cash</th><th>Comp</th></tr></thead>
    <tbody>
      {% for row in per_event %}
        <tr>
          <td>{{ row.ticket_type__event__name }}</td>
          <td>{{ row.ticket_type__event__start|date:"Y-m-d H:i" }}</td>
          <td>{{ row.sold }}</td>
          <td>{{ row.card }}</td>
          <td>{{ row.cash }}</td>
          <td>{{ row.comp }}</td>
        </tr>
      {% empty %}
        <tr><td colspan="6" class="muted">No sales yet.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="card">
  <h3>Conversion by Link (last {{ days }} days)</h3>
  <form method="get" style="margin-bottom:10px;">
    <div class="form-row">
      <input class="input" type="number" name="days" min="1" value="{{ days }}">
      <button class="btn">Apply</button>
    </div>
  </form>
  <table class="table">
    <thead><tr><th>Event</th><th>Date</th><th>Share URL</th><th>Hits</th><th>Sales</th><th>Conv%</th><th>Actions</th></tr></thead>
    <tbody>
      {% for r in conv_rows %}
        <tr>
          <td>{{ r.event_name }}</td>
          <td>{{ r.event_start|date:"Y-m-d H:i" }}</td>
          <td>
            <!-- “tracked” share URL (logs hit, then redirects) -->
            <a href="{% url 'control:events:artist_link_redirect' r.token %}" target="_blank">
              {% url 'control:events:artist_link_redirect' r.token %}
            </a>
          </td>
          <td>{{ r.hits }}</td>
          <td>{{ r.sales }}</td>
          <td>{% if r.rate is not None %}{{ r.rate|floatformat:1 }}%{% else %}—{% endif %}</td>
		  <td>
			<a href="{% url 'control:events:artist_link_redirect' r.token %}">Card</a>
			<a href="{% url 'control:events:artist_cash_sale' r.event_id request.user.artist_dashboard.id %}">Cash</a></td>
        </tr>
      {% empty %}
        <tr><td colspan="6" class="muted">No links yet.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="card">
  <h3>Last 30 Days — Tickets per Day</h3>
  <table class="table">
    <thead><tr><th>Date</th><th>Tickets</th></tr></thead>
    <tbody>
      {% for d in timeline %}
        <tr><td>{{ d.date }}</td><td>{{ d.count }}</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="card">
  <h3>Quick Links</h3>
  <div class="form-row">
    <a class="btn" href="{% url 'control:pages:artist_edit' artist.id %}">Edit Artist</a>
    {% if request.user != artist.user %}
        <a class="btn" href="{% url 'control:events:event_artists' 0 %}" onclick="event.preventDefault();history.back();">Event Artists</a>
    {% endif %}
  </div>
  <p class="muted">Tip: From an event’s Artists page you can grab the per-event URL/QR and record cash sales.</p>
</div>
{% endblock %}
