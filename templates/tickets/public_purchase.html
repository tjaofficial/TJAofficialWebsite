{% extends "base.html" %}
{% load static %}{% load shop_extras %}
{% block title %}Buy Tickets — {{ event.name }}{% endblock %}
{% block extra_head %}
	<link rel="stylesheet" href="{% static 'css/public_purchase.css' %}">
	<script defer src="{% static 'js/public_purchase.js' %}"></script>
{% endblock %}
{% block content %}
	<main class="ppx">
		<header class="ppx-hero">
			<div class="ppx-hero__text">
				<h1 class="ppx-title">Buy Tickets</h1>
				<div class="ppx-subtitle">
					<span class="ppx-event-name">{{ event.name }}</span>
					{% if event.start %}
						<span class="dot">•</span>
						<time datetime="{{ event.start|date:'c' }}">{{ event.start|date:"D, M j @ g:ia" }}</time>
					{% endif %}
					{% if event.venue %}
						<span class="dot">•</span>
						<span class="ppx-venue">
							{{ event.venue.name }}
							{% if event.venue.city %} — {{ event.venue.city }}{% if event.venue.state %}, {{ event.venue.state }}{% endif %}{% endif %}
						</span>
					{% endif %}
				</div>
			</div>
		</header>

  <form id="ppx-form" method="post" action="{% url 'control:tickets:public_checkout' event.id %}" novalidate data-auth="{{ user.is_authenticated|yesno:'1,0' }}">
    {% csrf_token %}
    {% if artist_token %}
      <input type="hidden" name="artist_token" value="{{ artist_token }}">
    {% endif %}

    <!-- Purchaser -->
    <section class="ppx-card">
		<div style="display: flex; justify-content: space-between;">
			<h2 class="ppx-h2">Your Info</h2>
			{% if not user.is_authenticated %}
				<div class="ppx-login-cta">
					<a class="btn-secondary" id="ppx-login-btn" href="{{ login_href }}">Log in to earn points</a>
					<span class="ppx-cta-sep">or</span>
					<span class="ppx-cta-guest">Checkout as guest</span>
				</div>
			{% else %}
				<div class="ppx-note">You’re logged in. Tickets will be linked to your account for points.</div>
			{% endif %}
		</div>

		{% if user.is_authenticated %}
			<!-- Display-only for UX, but we also POST hidden values to be safe -->
			<div class="ppx-grid-2">
				<div class="ppx-field">
					<span><strong>Name:</strong> {{ request.user.first_name }} {{ request.user.last_name|default:'' }}</span>
				</div>
				<div class="ppx-field">
					<span><strong>Email:</strong> {{ user.email }}</span>
				</div>
			</div>
			<!-- Hidden fields so POST always has values (even though the view uses request.user) -->
			<input type="hidden" name="purchaser_name" value="{% firstof request.user.get_full_name request.user.username %}">
			<input type="hidden" name="email" value="{{ user.email }}">
		{% else %}
			<div class="ppx-grid-2">
				<label class="ppx-field">
					<span><strong>Name</strong></span>
						<input class="ppx-input" name="purchaser_name" placeholder="Your name" required>
					</label>
					<label class="ppx-field">
						<span><strong>Email</strong></span>
					<input class="ppx-input" type="email" name="email" placeholder="you@example.com" required>
				</label>
			</div>
		{% endif %}
    </section>

    <!-- Ticket Types -->
    <section class="ppx-card">
      <div class="ppx-card__hdr">
        <h2 class="ppx-h2">Tickets</h2>
        <div class="ppx-note">Choose quantities below. Subtotal updates live.</div>
      </div>

      <div class="ppx-types">
        {% for tt in types %}
          {% with rem=tt.remaining|default:0 %}
          {% with max_order=tt.max_per_order|default_if_none:0 %}
          {% with limit=rem %}
          {% if max_order and max_order < rem %}
            {% with limit=max_order %}
            {% endwith %}
          {% endif %}

          <article class="ppx-type {% if rem <= 0 %}is-soldout{% endif %}"
                   data-tt-id="{{ tt.id }}"
                   data-price-cents="{{ tt.price_cents }}"
                   data-remaining="{{ rem }}"
                   {% if max_order %}data-max="{{ max_order }}"{% endif %}>
            <div class="ppx-type__main">
              <div class="ppx-type__name">
                <span class="ppx-type__title">{{ tt.name }}</span>
                {% if tt.description %}
                  <span class="ppx-type__desc">{{ tt.description }}</span>
                {% endif %}
              </div>
              <div class="ppx-type__meta">
                <span class="ppx-price">{{ tt.price_cents|money }}</span>
                {% if rem > 0 %}
                  <span class="ppx-remaining">{{ rem }} left</span>
                {% else %}
                  <span class="ppx-soldout">Sold out</span>
                {% endif %}
              </div>
            </div>

            <div class="ppx-type__qty">
              {% if rem > 0 %}
                <div class="ppx-stepper" data-limit="{{ limit }}">
                  <button class="ppx-step btn-step dec" type="button" aria-label="Decrease">–</button>
                  <input class="ppx-input qty-input"
                         type="number"
                         min="0"
                         max="{{ limit }}"
                         value="0"
                         name="qty_{% firstof tt.id %}"
                         inputmode="numeric"
                         pattern="[0-9]*">
                  <button class="ppx-step btn-step inc" type="button" aria-label="Increase">+</button>
                </div>
                <div class="ppx-line-total" aria-live="polite" data-line-total>—</div>
              {% else %}
                <div class="ppx-soldout-badge">Not available</div>
              {% endif %}
            </div>
          </article>

          {% endwith %}
          {% endwith %}
          {% endwith %}
        {% empty %}
          <p class="ppx-empty">No ticket types are available yet. You can <a href="{% url 'email_signup' %}?event={{ event.id }}">RSVP for updates</a>.</p>
        {% endfor %}
      </div>
    </section>

    <!-- Sticky Summary -->
    <div class="ppx-summary" id="ppx-summary">
      <div class="ppx-summary__left">
        <span class="ppx-summary__label">Subtotal</span>
        <span class="ppx-summary__value" id="ppx-subtotal">$0.00</span>
        <span class="ppx-summary__hint">Taxes/fees shown on next step</span>
      </div>
      <div class="ppx-summary__right">
        <button id="ppx-submit" class="btn-primary" {% if not user.is_authenticated %}disabled{% endif %}>Continue to Checkout</button>
      </div>
    </div>

    <!-- Fallback submit (in case JS disabled) -->
    <div class="ppx-fallback-submit">
      <button class="btn-primary">Continue to Checkout</button>
    </div>
  </form>
</main>
{% endblock %}
