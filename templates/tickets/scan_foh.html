{% extends 'controlpanel/dashboard.html' %}{% load static %}
{% block title %}FOH Scanner{% endblock %}
{% block head %}
  <style>
    .foh-wrap {min-height: calc(100vh - 60px);}
    .foh-stage {display:flex;align-items:center;justify-content:center;min-height:60vh;border:1px solid #1a1f27;border-radius:16px;background:#0f1318;position:relative;overflow:hidden}
    .foh-big {font-size:64px;font-weight:800;margin:0;text-align:center}
    .foh-sub {font-size:18px;color:#9eb0c2;margin-top:8px;text-align:center}
    .foh-green {background:rgba(20,120,60,.7)}
    .foh-red {background:rgba(160,20,30,.7)}
    .foh-flash {position:absolute;inset:0;opacity:0;transition:opacity .15s ease; pointer-events: none;}
    .foh-flash.show {opacity:1}
    .foh-hide {display:none}
    .foh-input {width:100%;padding:14px;border-radius:8px;border:1px solid #1a1f27;background:#0f1318;color:#e7edf3}
    .foh-row {display:flex;gap:12px;margin-top:12px}
    .foh-card {padding:16px;border:1px solid #1a1f27;border-radius:12px;background:#0f1318;margin-top:16px}
    .foh-kv {display:grid;grid-template-columns:140px 1fr;gap:8px}
    .foh-kv div{padding:2px 0}
    #qrReader video { border-radius: 12px; }
  </style>
  <script src="https://unpkg.com/html5-qrcode"></script>

{% endblock %}
{% block content %}
<div class="foh-wrap">
  <h1>Front-of-House Scanner{% if autocheck %} (Auto Check-In){% endif %}</h1>

  <div class="foh-card">
    <div class="foh-row">
      <input id="scanInput" class="foh-input" placeholder="Scan QR or paste code..." autocomplete="off" autofocus>
      <button id="scanBtn" class="btn primary">Scan</button>
      <label style="display:flex;align-items:center;gap:6px;">
        <input type="checkbox" id="autocheck" {% if autocheck %}checked{% endif %}> Auto check-in
      </label>
    </div>
    <div class="foh-sub">Tip: Most USB scanners act like a keyboard and ‘type’ the code, then press Enter.</div>
  </div>

  <div class="foh-card">
    <div class="foh-row" style="align-items:center;">
      <button id="camStart" class="btn">Start Camera</button>
      <button id="camStop" class="btn" disabled>Stop</button>
      <div class="foh-sub" id="camStatus" style="margin:0;">Camera: idle</div>
    </div>

    <div id="qrWrap" class="foh-card" style="margin-top:12px;">
      <div id="qrReader" style="width: 100%; max-width: 520px;"></div>
      <div class="foh-sub" style="margin-top:8px;">
        Tip: Camera scanning works best over HTTPS (or localhost).
      </div>
    </div>
  </div>




  <div class="foh-stage" id="stage">
    <div id="flash" class="foh-flash"></div>
    <div id="idle">
      <p class="foh-big">Ready to scan</p>
      <p class="foh-sub">Focus the input and scan a ticket.</p>
    </div>
    <div id="ok" class="foh-hide">
      <p class="foh-big">VALID ✅</p>

      <div class="foh-kv">
        <div>Purchaser:</div><div id="ok_name"></div>
        <div>Event:</div><div id="ok_event"></div>
        <div>Type:</div><div id="ok_type"></div>
        <div>Email:</div><div id="ok_email"></div>
        <div>Checked-in:</div><div id="ok_checkin"></div>
      </div>

      <div class="foh-row" style="justify-content:center;margin-top:14px;">
        <button id="redeemBtn" type="button" class="btn primary foh-hide">Redeem / Check In</button>
        <button id="cancelBtn" type="button" class="btn foh-hide">Cancel</button>
      </div>
    </div>

    <div id="already" class="foh-hide">
      <p class="foh-big">ALREADY CHECKED-IN ⚠️</p>
      <div class="foh-kv">
        <div>Purchaser:</div><div id="al_name"></div>
        <div>Event:</div><div id="al_event"></div>
        <div>Type:</div><div id="al_type"></div>
        <div>Email:</div><div id="al_email"></div>
        <div>When:</div><div id="al_checkin"></div>
      </div>
    </div>
    <div id="bad" class="foh-hide">
      <p class="foh-big">INVALID ❌</p>
      <p class="foh-sub" id="bad_msg"></p>
    </div>
  </div>
</div>

<audio id="snd_ok" src="{% static 'tickets/snd_ok.mp3' %}" preload="auto"></audio>
<audio id="snd_err" src="{% static 'tickets/snd_err.mp3' %}" preload="auto"></audio>

<script>
(function(){
  const redeemBtn = document.getElementById('redeemBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  let pendingCode = null;

  const input = document.getElementById('scanInput');
  const btn   = document.getElementById('scanBtn');
  const stage = document.getElementById('stage');
  const flash = document.getElementById('flash');
  const autoc = document.getElementById('autocheck');

  const idle     = document.getElementById('idle');
  const ok       = document.getElementById('ok');
  const already  = document.getElementById('already');
  const bad      = document.getElementById('bad');

  const okSnd  = document.getElementById('snd_ok');
  const errSnd = document.getElementById('snd_err');

  let camStatus = null;
  let scanning = false;
  let lastCode = null;
  let lastAt = 0;


  function extractUuid(text){
    const m = (text || "").match(/[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}/i);
    return m ? m[0].toLowerCase() : null;
  }

  function show(which){
    [idle, ok, already, bad].forEach(el => el.classList.add('foh-hide'));
    which.classList.remove('foh-hide');
  }

  function flashColor(cls){
    flash.className = 'foh-flash ' + cls + ' show';
    setTimeout(()=> flash.classList.remove('show'), 180);
  }

  function resetSoon(force=false){
    if(!force && pendingCode) return; // waiting for Redeem/Cancel
    setTimeout(()=>{
      input.value = '';
      show(idle);
      pendingCode = null;
      redeemBtn.classList.add('foh-hide');
      cancelBtn.classList.add('foh-hide');
      input.focus();
      if (camStatus && scanning) camStatus.textContent = "Camera: scanning…";
    }, 900);
  }



  async function doScan(raw){
    if(!raw) return;
    const body = JSON.stringify({ code: raw, autocheckin: autoc.checked });
    try{
      const res = await fetch("{% url 'control:tickets:scan_api' %}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body
      });
      const data = await res.json();

      if(data.status === 'ok'){
        if (camStatus && scanning) camStatus.textContent = "Camera: VALID ✅";

        document.getElementById('ok_name').textContent  = data.ticket.name || '';
        document.getElementById('ok_event').textContent = data.ticket.event || '';
        document.getElementById('ok_type').textContent  = data.ticket.type || '';
        document.getElementById('ok_email').textContent = data.ticket.email || '';
        document.getElementById('ok_checkin').textContent =
          data.ticket.checked_in_at
            ? new Date(data.ticket.checked_in_at).toLocaleString()
            : (autoc.checked ? 'now' : 'not yet');

        show(ok);

        // Green feedback always for a valid ticket
        flashColor('foh-green');
        okSnd && okSnd.play().catch(()=>{});

        // If autocheck is OFF, wait for user action
        if(!autoc.checked){
          pendingCode = extractUuid(raw) || raw; // store clean token if possible
          redeemBtn.classList.remove('foh-hide');
          cancelBtn.classList.remove('foh-hide');
          if (camStatus && scanning) camStatus.textContent = "Camera: waiting for Redeem…";
          return;
        }

        // Autocheck is ON, so reset for next scan
        resetSoon();

      }else if(data.status === 'already'){
        if (camStatus && scanning) camStatus.textContent = "Camera: already checked-in ⚠️";
        document.getElementById('al_name').textContent = data.ticket.name || '';
        document.getElementById('al_event').textContent = data.ticket.event || '';
        document.getElementById('al_type').textContent  = data.ticket.type || '';
        document.getElementById('al_email').textContent = data.ticket.email || '';
        document.getElementById('al_checkin').textContent = data.ticket.checked_in_at ? new Date(data.ticket.checked_in_at).toLocaleString() : '';
        show(already);
        flashColor('foh-red');
        errSnd && errSnd.play().catch(()=>{});
        resetSoon();
      }else{
        if (camStatus && scanning) camStatus.textContent = "Camera: INVALID ❌";
        document.getElementById('bad_msg').textContent = data.message || 'Unknown code';
        show(bad);
        flashColor('foh-red');
        errSnd && errSnd.play().catch(()=>{});
        resetSoon();
      }
    }catch(e){
      if (camStatus && scanning) camStatus.textContent = "Camera: network error";
      document.getElementById('bad_msg').textContent = 'Network error';
      show(bad);
      flashColor('foh-red');
      errSnd && errSnd.play().catch(()=>{});
      resetSoon();
    }
  }

  btn.addEventListener('click', (e)=>{ e.preventDefault(); doScan(input.value.trim()); });
  input.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
      e.preventDefault();
      doScan(input.value.trim());
    }
  });

  window.addEventListener('click', (e) => {
    // If we're waiting for Redeem/Cancel, DO NOT steal focus (prevents jump)
    if (pendingCode) return;

    // Don't steal focus when clicking buttons/inputs/camera
    if (e.target.closest('button, input, label, #qrWrap, #qrReader')) return;

    input.focus({ preventScroll: true });
  });

  input.focus({ preventScroll: true });


    // --- Camera QR Scanner (html5-qrcode) ---
  const camStartBtn = document.getElementById('camStart');
  const camStopBtn  = document.getElementById('camStop');
  camStatus = document.getElementById('camStatus');


  let html5Qr = null;

  function canScanAgain(code){
    // prevent rapid double-fires if camera keeps seeing the same QR
    const now = Date.now();
    if(code === lastCode && (now - lastAt) < 1500) return false;
    lastCode = code;
    lastAt = now;
    return true;
  }

  async function startCamera(){
    if(scanning) return;
    if(typeof Html5Qrcode === "undefined"){
      camStatus.textContent = "Camera: scanner library not loaded";
      return;
    }

    html5Qr = html5Qr || new Html5Qrcode("qrReader");
    camStatus.textContent = "Camera: starting...";
    try{
      scanning = true;
      camStartBtn.disabled = true;
      camStopBtn.disabled = false;

      // Prefer rear camera when available
      const config = { fps: 12, qrbox: { width: 280, height: 280 } };

      await html5Qr.start(
        { facingMode: "environment" },
        config,
        (decodedText) => {
          const text = (decodedText || "").trim();
          if (!text) return;

          // If we're waiting on Redeem/Cancel, pause scanning.
          if (pendingCode) return;

          // Debounce on UUID when possible (more stable than full URL text)
          const token = extractUuid(text) || text;

          if (!canScanAgain(token)) return;

          camStatus.textContent = "Camera: checking…";
          doScan(text);
        },

        () => { /* ignore per-frame decode errors */ }
      );

      camStatus.textContent = "Camera: scanning…";
    }catch(err){
      scanning = false;
      camStartBtn.disabled = false;
      camStopBtn.disabled = true;
      camStatus.textContent = "Camera: failed to start (check permissions / HTTPS)";
      console.error(err);
    }
  }

  async function stopCamera(){
    if(!html5Qr || !scanning) return;
    camStatus.textContent = "Camera: stopping...";
    try{
      await html5Qr.stop();
      document.getElementById("qrReader").innerHTML = "";
      html5Qr = null;
    }catch(e){
      console.warn(e);
    }finally{
      scanning = false;
      camStartBtn.disabled = false;
      camStopBtn.disabled = true;
      camStatus.textContent = "Camera: stopped";
    }
  }


  camStartBtn && camStartBtn.addEventListener("click", (e)=>{ e.preventDefault(); startCamera(); });
  camStopBtn && camStopBtn.addEventListener("click", (e)=>{ e.preventDefault(); stopCamera(); });

  redeemBtn.addEventListener('click', async (e)=>{
    e.preventDefault();
    e.stopPropagation();

    if(!pendingCode) return;

    redeemBtn.disabled = true;
    redeemBtn.textContent = "Checking in...";

    const body = JSON.stringify({ code: pendingCode, redeem: true });

    try{
      const res = await fetch("{% url 'control:tickets:scan_api' %}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body
      });

      const data = await res.json();
      console.log("Redeem response:", data);

      if(data.status === 'ok'){
        // update check-in time from server
        document.getElementById('ok_checkin').textContent =
          data.ticket.checked_in_at ? new Date(data.ticket.checked_in_at).toLocaleString() : 'now';

        flashColor('foh-green');
        okSnd && okSnd.play().catch(()=>{});

      } else if (data.status === 'already') {
        // show already state (idempotent)
        document.getElementById('al_name').textContent = data.ticket.name || '';
        document.getElementById('al_event').textContent = data.ticket.event || '';
        document.getElementById('al_type').textContent  = data.ticket.type || '';
        document.getElementById('al_email').textContent = data.ticket.email || '';
        document.getElementById('al_checkin').textContent =
          data.ticket.checked_in_at ? new Date(data.ticket.checked_in_at).toLocaleString() : '';

        show(already);
        flashColor('foh-red');
        errSnd && errSnd.play().catch(()=>{});
      } else {
        document.getElementById('bad_msg').textContent = data.message || 'Redeem failed';
        show(bad);
        flashColor('foh-red');
        errSnd && errSnd.play().catch(()=>{});
      }

    } catch (err) {
      console.error(err);
      document.getElementById('bad_msg').textContent = 'Network error';
      show(bad);
      flashColor('foh-red');
      errSnd && errSnd.play().catch(()=>{});
    } finally {
      redeemBtn.disabled = false;
      redeemBtn.textContent = "Redeem / Check In";

      pendingCode = null;
      lastCode = null;
      lastAt = 0;

      redeemBtn.classList.add('foh-hide');
      cancelBtn.classList.add('foh-hide');

      resetSoon(true);
    }
  });

  cancelBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    e.stopPropagation();

    pendingCode = null;
    lastCode = null;
    lastAt = 0;

    redeemBtn.classList.add('foh-hide');
    cancelBtn.classList.add('foh-hide');

    if (camStatus && scanning) camStatus.textContent = "Camera: scanning…";
    resetSoon(true);
  });



})();
</script>
{% endblock %}
